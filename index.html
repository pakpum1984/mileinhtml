<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>milein</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background-color: #f4f4f4;
    }
    #container {
      max-width: auto;
      margin: 5vh auto;
      border: 2px solid #ffffff;
      /* สีน้ำเงิน สามารถเปลี่ยนสีได้ */
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
      /* เพิ่มเงาดำ */
    }
    .spinner-container {
        justify-content: center;
      align-items: center;
      display: flex;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
    }

  </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="##" style="color:white;">บันทึกไมล์เข้า</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/carlendar.html">ปฏิทินจองรถ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/carlendarcus.html">ปฏิทินลูกค้า</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/mileout.html">บันทึกไมล์ออก</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/index.html">หน้าจองรถ</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <!-- <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> -->
        <!-- <button type="button" onclick="logoutcar()" class="btn btn-danger"  style="margin-left: auto;">Logout</button> -->
          </form>



          </div>
        </div>
      </nav>


<div class="modal fade" id="editModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel1">บันทึกเลขไมล์เข้า</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="myFormsave1" onsubmit="saveData1(event)" class="row g-2">

            <input type="text" class="form-control" id="editId1" readonly hidden>

         <div class="col-12 col-md-6 mb-2">
            <label for="editNamebook" class="form-label">ชื่อผู้จอง:</label>
            <input type="text" class="form-control" id="editNamebook1" name="editNamebook1" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editDepbook" class="form-label">แผนก:</label>
            <input type="text" class="form-control" id="editDepbook1" name="editDepbook1" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editCarbook" class="form-label">รถที่จอง</label>
            <input type="text" class="form-control" id="editCarbook1" name="editCarbook1" style="color: blue;">
          </div>
          <div class="col-12 col-md-6 mb-2">
            <label for="editLocabook" class="form-label">สถานที่ๆไปติดต่อ</label>
            <input type="text" class="form-control" id="editLocabook1" name="editLocabook1" style="color: blue;">
          </div>

            <input type="date" class="form-control" id="editDateoutbook1" name="editDateoutbook1" style="display: none;">

            <input type="text" class="form-control" id="editTimeoutbook1" name="editTimeoutbook1" style="display: none;">

            <input type="text" class="form-control" id="editTimeinbook1" name="editTimeinbook1" style="display: none;">


            <input type="text" class="form-control" id="editDrivebook1" name="editDrivebook1" style="display: none;">



            <input type="text" class="form-control" id="editStatusbook1" name="editStatusbook1" value="เสร็จงาน" style="display: none;">


            <input type="text" class="form-control" id="editApproverbook1" name="editApproverbook1" style="display: none;">
            <input type="time" class="form-control" id="editTimeout1" name="editTimeout1" style="display: none;" >
          <input type="text" class="form-control" id="editMileout1" name="editMileout1" style="display: none;">
          <div class="col-6 col-md-6 mb-2">
            <label for="editDateout" class="form-label">วันที่ออก</label>
            <input type="date" class="form-control" id="editDateout1" name="editDateout1" style="color: blue;">
          </div>
         <div class="col-6 col-md-6 mb-2">
            <label for="editTimeout" class="form-label">เวลาเข้า</label>
            <input type="time" class="form-control" id="editTimein" name="editTimein" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editMileout" class="form-label">เลขไมล์เข้า</label>
            <input type="tel" class="form-control" id="editMilein" name="editMilein" style="color: blue;">
          </div>
         <div class="col-6 col-md-6 mb-2">
            <label for="editDriver" class="form-label">ชื่อคนขับ</label>
            <input type="text" class="form-control" id="editDriver1" name="editDriver1" style="color: blue;" required>
          </div>
          <div class="col-12 col-md-12 mb-2">
            <label for="editOtherbook" class="form-label">อื่นๆ</label>
            <input type="text" class="form-control" id="editOtherbook1" name="editOtherbook1">
          </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        <button type="submit" class="btn btn-primary" onclick="saveData1(event)">บันทึก</button>
        </form>
      </div>
    </div>
  </div>
</div>





   <!-- <div class="container"> -->
    <div class="container table-responsive mt-4">
    <table id="dataTable1" class="table table-striped table-bordered" style="width:100%; font-size:12px;">
      <thead class="bg-success text-white">
        <tr id="tableHeade1r"></tr>
      </thead>
      <tbody id="tableBody1"></tbody>
    </table>
    <br>
  </div>
      <!-- </div> -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JavaScript -->
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script>


    var googleScriptUrl1 = 'https://script.google.com/macros/s/AKfycbw5l1B6bLiiGk_M1Jjc-0zrJ3TzL1uA2HX7LnzVoli04JtWo7kY7fw1QRdm0zvBPUDN/exec'; // ใส่ URL ของ Google Apps Script ที่คุณสร้าง
$(document).ready(function() {
  $('#dataTable1').html('<div class="spinner-container"><div class="spinner-border text-info me-2" style="width: 40px; height: 40px;" role="status"></div> กำลังโหลดข้อมูลไมล์เข้า...</div>');

  $.ajax({
    url: googleScriptUrl1,
    dataType: 'json',
    success: function(data) {
      // เมื่อโหลดข้อมูลเสร็จสิ้นซ่อน spinner
      $('#dataTable1').empty();

      var headerRow1 = [

      { title: 'ไอดี', visible: false },
        { title: 'ชื่อผู้จอง' },
        { title: 'แผนก', visible: false  },
        { title: 'รถที่จอง' },
         { title: 'สถานที่ๆไปติดต่อ' },
         { title: 'วันที่ใช้รถ' , render: function (data) { return moment(data, 'YYYY-MM-DD').format('DD-MM-YYYY'); }},
         { title: 'ออกเวลา' },
         { title: 'เข้าเวลา' },
         { title: 'สถานะการขับ', visible: false  },
         { title: 'อื่นๆ', visible: false   },
         { title: 'สถานะการจอง', visible: false  },
         { title: 'อนุมัติโดย', visible: false  },
        { title: 'วันที่ออก', visible: false  },
        { title: 'เวลาออก', visible: false  },
        { title: 'เลขไมล์ออก', visible: false  },
        { title: 'แก้ไข' }


      ];
      var tableRows1 = [];

      $.each(data, function(index, row) {
        var editButton1 = '<button type="button" onclick="editData1(this);" class="btn btn-success edit-button" data-bs-toggle="modal" data-bs-target="#editModal1" data-index="' + index + '" data-row=\'' + JSON.stringify(row) + '\'><i class="fa-solid fa-pen-to-square" style="color: white;"></i></button>';
        var deleteButton1 = '<button type="button" onclick="deleteData(\'' + row['ไอดี'] + '\');" class="btn btn-danger delete-button"><i class="fa-solid fa-trash-can" style="color: white;"></i></button>';

        // var actiondeleteButtons = '<div class="btn-group" role="group">' + deleteButton + '</div>';
        var actioneditButtons1 = '<div class="btn-group" role="group">' + editButton1 + '</div>';

        var rowData1 = [

          row['ไอดี'],
          row['ชื่อผู้จอง'],
          row['แผนก'],
          row['รถที่จอง'],
          row['สถานที่ๆไปติดต่อ'],
          row['วันที่ใช้รถ'],
          row['ออกเวลา'],
          row['เข้าเวลา'],
          row['สถานะการขับ'],
          row['อื่นๆ'],
          row['สถานะการจอง'],
          row['อนุมัติโดย'],
          row['เลขไมล์ออก'],
          row['เวลาเข้า'],
          row['เลขไมล์เข้า'],
          actioneditButtons1

        ];
        tableRows1.push(rowData1);
      });

      $('#dataTable1').DataTable({
        data: tableRows1,
        columns: headerRow1,
        dom: 't',
        order: [[5, 'asc']]
      });
    },
    error: function(xhr, status, error) {
      console.error('Error fetching data:', status, error);
    }
  });
});



    
    // เมื่อคลิกที่ปุ่ม "เพิ่มข้อมูล"
    $('.btn-warning').click(function() {
      // รีเซ็ตค่าในฟอร์มเพื่อเตรียมการเพิ่มข้อมูลใหม่
      $('#editId1').val('');
      $('#editNamebook1').val('');
      $('#editDepbook1').val('');
      $('#editCarbook1').val('');
      $('#editLocabook1').val('');
      $('#editDateoutbook1').val('');
      $('#editTimeoutbook1').val('');
      $('#editTimeinbook1').val('');
      $('#editDrivebook1').val('');
      $('#editOtherbook1').val('');
      $('#editStatusbook1').val('');
      $('#editApproverbook1').val('');
      $('#editDateout1').val('');
      $('#editTimeout1').val('');
      $('#editMileout1').val('');
      $('#editTimein').val('');
      $('#editMilein').val('');
      $('#editDriver1').val('');

      // แสดง modal เพื่อเพิ่มข้อมูล
      $('#addDataModal1').modal('show');
    });






function editData1(button) {
  var index = $(button).data('index');
  var row = $(button).data('row');

  // ตั้งค่าข้อมูลใน input ใน modal
  $('#editId1').val(row['ไอดี']);
  $('#editNamebook1').val(row['ชื่อผู้จอง']);
  $('#editDepbook1').val(row['แผนก']);
   $('#editCarbook1').val(row['รถที่จอง']);
   $('#editLocabook1').val(row['สถานที่ๆไปติดต่อ']);
   $('#editDateoutbook1').val(row['วันที่ใช้รถ']);
   $('#editTimeoutbook1').val(row['ออกเวลา']);
   $('#editTimeinbook1').val(row['เข้าเวลา']);
   $('#editDrivebook1').val(row['สถานะการขับ']);
   $('#editOtherbook1').val(row['อื่นๆ']);
  // $('#editStatusbook').val(row['สถานะการจอง']);
   $('#editApproverbook1').val(row['อนุมัติโดย']);
   $('#editDateout1').val(row['วันที่ใช้รถ']);
   $('#editTimeout1').val(row['เวลาเข้า']);
   $('#editMileout1').val(row['เลขไมล์เข้า']);
   $('#editDriver1').val(row['ชื่อผู้ขับขี่']);


  // กำหนดค่า index ของแถวที่ต้องการแก้ไขให้กับ modal
  $('#editModal1').data('index', index);

  // แสดง modal
  $('#editModal1').modal('show');
}

    function saveData1(event) {
      event.preventDefault(); // หยุดการส่งค่าฟอร์มทางเบราว์เซอร์
    Swal.fire({
            position: 'center',
            title: '<h4>กำลังบันทึกข้อมูล...</h4>',
            showConfirmButton: false,
          })
           Swal.showLoading()
      // ดึงข้อมูลที่แก้ไขจาก input ใน modal
      var id1 = $('#editId1').val();
      var editNamebook1 = $('#editNamebook1').val();
      var editDepbook1 = $('#editDepbook1').val();
      var editCarbook1 = $('#editCarbook1').val();
      var editLocabook1 = $('#editLocabook1').val();
      var editDateoutbook1 = $('#editDateoutbook1').val();
      var editTimeoutbook1 = $('#editTimeoutbook1').val();
      var editTimeinbook1 = $('#editTimeinbook1').val();
      var editDrivebook1 = $('#editDrivebook1').val();
      var editOtherbook1 = $('#editOtherbook1').val();
      var editStatusbook1 = $('#editStatusbook1').val();
      var editApproverbook1 = $('#editApproverbook1').val();
      var editDateout1 = $('#editDateout1').val();
      var editTimeout1 = $('#editTimeout1').val();
      var editMileout1 = $('#editMileout1').val();
      var editTimein = $('#editTimein').val();
      var editMilein = $('#editMilein').val();
      var editDriver1 = $('#editDriver1').val();


      if (editTimein == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณากรอกเวลาออก</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      } else if (editMilein == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณากรอกเลขไมล์ออก</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      }  else if (editDriver1 == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณาระบุชื่อคนขับ</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      }

      // สร้าง JSON object ที่มีข้อมูลที่แก้ไขแล้ว
      var editedData1 = {
        'ไอดี': id1,
        'ชื่อผู้จอง': editNamebook1,
        'แผนก': editDepbook1,
        'รถที่จอง': editCarbook1,
        'สถานที่ๆไปติดต่อ': editLocabook1,
        'วันที่ใช้รถ': editDateoutbook1,
        'ออกเวลา': editTimeoutbook1,
        'เข้าเวลา': editTimeinbook1,
        'สถานะการขับ': editDrivebook1,
        'อื่นๆ': editOtherbook1,
        'สถานะการจอง': editStatusbook1,
        'อนุมัติโดย': editApproverbook1,
        'วันที่ออก': editDateout1,
        'เวลาออก': editTimeout1,
        'เลขไมล์ออก': editMileout1,
        'เวลาเข้า': editTimein,
        'เลขไมล์เข้า': editMilein,
        'ชื่อผู้ขับขี่': editDriver1
      };

      // แปลง JSON object เป็น string JSON
      var jsonData1 = JSON.stringify(editedData1);

      fetch(googleScriptUrl1, {
        method: 'POST',
        body: jsonData1 // ข้อมูลที่แก้ไข
      })
      .then(response => response.json()) // เปลี่ยนจาก response.text() เป็น response.json() เนื่องจากข้อมูลที่ส่งกลับมาเป็น JSON
      .then(data => {
        document.getElementById("myFormsave1").reset();
       Swal.fire({
  position: 'center',
  icon: 'success',
  title: 'แก้ไขข้อมูลเรียบร้อยแล้ว',
  showConfirmButton: false,
  timer: 2500
})
        console.log(data);
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }








    // ฟังก์ชั่น deleteData เพื่อลบข้อมูล
    function deleteData(id) {
      Swal.fire({
        //title: "Are you sure?",
        text: "คุณต้องการลบข้อมูลใช่หรือไม่!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ใช่ต้องการลบข้อมูล"
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
              position: 'center',
              title: '<h4>กำลังลบข้อมูล...</h4>',
              showConfirmButton: false,
          });
          Swal.showLoading();
          // ส่งข้อมูล ID ที่ต้องการลบไปยัง Google Apps Script ผ่าน AJAX request
          $.ajax({
            url: googleScriptUrl, // URL ของ Google Apps Script
            method: 'POST',
            dataType: 'json',
            data: { id: id }, // ส่งข้อมูล ID เพื่อลบ
            success: function(response) {
              if (response.success) {
                Swal.fire({
                  //title: "ลบข้อมูล",
                  text: "ลบข้อมุลเรียบร้อยแล้ว",
                  icon: "success"
                }).then(() => {
                  // รีโหลดหน้าหลังจากที่ข้อมูลถูกลบเรียบร้อย
                  location.reload();
                });
              } else {
                console.error('Error deleting data:', response.error);
                alert('An error occurred while deleting data. Please try again later.');
              }
            },
            error: function(xhr, status, error) {
              console.error('Error deleting data:', status, error);
              alert('An error occurred while deleting data. Please try again later.');
            }
          });
        }
      });
    }




  </script>
   <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
